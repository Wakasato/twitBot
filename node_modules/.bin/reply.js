
var app = require('../../app')
var Twit = require('twit');
const BOT_ID = 'MY_BOT_ID';
var options = app.get('options')
const config = require('../../config');
var request = require('request').defaults({strictSSL: false})
// docomo雑談対話API
var api = "xxxxx"　　/* 各自記入 */,
var token = options.dialog_token
// context保存用
var status = {}

var twitter = new Twit({
   consumer_key        : "XXXXXXXXX" /* 各自記入 */,
  consumer_secret     : "XXXXXXXXX" /* 各自記入 */,
  access_token    : "XXXXXXXXX" /* 各自記入 */,
  access_token_secret : "XXXXXXXXX" /* 各自記入 */
});
var stream = twitter.stream('user')

// ダイレクトメッセージハンドリング
stream.on('direct_message', function(data) {
  var message = data.direct_message
  // 自分が送信したダイレクトメッセージは処理しない
  if (message.sender_id_str === options.id) return

  // 雑談対話API呼び出し
  status.utt = message.text
  status.nickname = message.sender_screen_name
  var param = { body: JSON.stringify(status) }  //うまくいっている　paramは取得
  request.post(api, param, function(err, res, data) {
    console.log(data)
    body = JSON.parse(data)　//dataは取得できている　perseがうまくいっていない模様
    // 雑談対話の文脈保存　　
    status.context = body.context
    status.mode = body.mode
    
    // 雑談対話APIで得られた回答内容でtweet
   // var reply = { user_id: message.sender_id_str, text: body.utt }
    twitter.post('statuses/update',
    { status: '@'+ status.nickname + body.yomi}, 
    function(err, data, res) {
      console.log(data)
    })
  })
})


　
  